"""${TOOL_NAME} — ${TOOL_DESCRIPTION}"""

from contextlib import asynccontextmanager
from datetime import datetime
from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse
from pathlib import Path

from .routes import router
from .database import db


@asynccontextmanager
async def lifespan(app: FastAPI):
    """Initialize and clean up resources."""
    db.initialize()
    yield
    db.close()


app = FastAPI(
    title="${TOOL_NAME}",
    description="${TOOL_DESCRIPTION}",
    version="1.0.0",
    lifespan=lifespan,
)

# CORS — restrict origins in production
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Include API routes
app.include_router(router, prefix="/api")


@app.middleware("http")
async def audit_middleware(request: Request, call_next):
    """Log all requests for HIPAA audit trail."""
    start_time = datetime.utcnow()
    response = await call_next(request)
    duration = (datetime.utcnow() - start_time).total_seconds()
    db.log_audit(
        user=request.headers.get("X-User", "anonymous"),
        action=request.method,
        resource_type=request.url.path,
        resource_id="",
        details=f"status={response.status_code} duration={duration:.3f}s",
    )
    return response


@app.get("/", response_class=HTMLResponse)
async def serve_frontend():
    """Serve the frontend application."""
    frontend_path = Path(__file__).parent.parent / "frontend" / "index.html"
    if frontend_path.exists():
        return HTMLResponse(content=frontend_path.read_text())
    return HTMLResponse(content="<h1>${TOOL_NAME}</h1><p>Frontend not found.</p>")


@app.get("/health")
async def health_check():
    """Health check endpoint for Docker."""
    return {"status": "healthy", "timestamp": datetime.utcnow().isoformat()}
